<!doctype html>
<html lang="en" class="perfect-scrollbar-on">
    <head>
        <meta http-equiv="Content-Type" content="text/html"; charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no, user-scalable=no">

        <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/bla.css') }}">
        <link rel="icon" type="image/jpg" sizes="32x32" href="{{ url_for('static',filename='images/favicon.jpg') }}">
        
        <title>
            Site Safety Detection
        </title>

        <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet">
        <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
        <link href="https://appsrv1-147a1.kxcdn.com/black-dashboard/css/nucleo-icons.css" rel="stylesheet">

        <link rel="stylesheet" href="https://js.arcgis.com/3.40/dijit/themes/nihilo/nihilo.css">
        <link rel="stylesheet" href="https://js.arcgis.com/3.40/esri/css/esri.css">


    </head>
        
    <body class style>
        <div class="wrapper">
            <div id="my_sidebar" class="sidebar">  
                <div class="sidebar-wrapper ps">  
                    <div class="closebtn" onclick="closeNav()">
                        Ã—
                    </div>
                    <div class="logo" style="padding-right: 100px; padding-bottom: 20px;">
                        <img src="{{ url_for('static',filename='images/logo.png') }}" alt="Logo_Viu_More">
                    </div>
                    <ul class="nav">
                      <li class>
                        <a href="/">
                        <i class="tim-icons icon-chart-pie-36"></i>
                        <p>My Dashboard</p>
                        </a>
                      </li>
                      <li class>
                        <a href="/livestreams_overview/1">
                          <i class="tim-icons icon-atom"></i>
                          <p>Overview Livestreams</p>
                          </a>
                      </li>
                        <li class = "active">
                            <a href="/my_cameras">
                            <i class="tim-icons icon-video-66"></i>
                            <p>My Cameras</p>
                            </a>
                        </li>
                        <li class="list-unstyled">
                          <ul>
                              <li class = active> 
                                <i class="tim-icons icon-simple-add"></i>
                                  <p>Add Zone</p>
                                  </a>
                              </li>
                          </ul>
                          </li>
                    </ul>
                    <div class="ps__rail-x" style="left: 0px; bottom: 0px;">
                        <div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                    </div>
                    <div class="ps__rail-y" style="top: 0px; right: 0px;">
                        <div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 0px;"></div>
                    </div>
                </div>
            </div>

            <div id="open_sidebar_button"></div>
                    <button class="openbtn" onclick="openNav()"><b>></b></button>
            </div>

            <div id="main">
                <div class="main-panel ps">
                <!-- Navbar -->
                <nav class="navbar navbar-expand-lg navbar-absolute navbar-transparent">
                    <div class="container-fluid">
                        <div class="collapse navbar-collapse" id="navigation">
                            <ul class="navbar-nav ml-auto">
                                <li class>
                                    <a href="#">
                                        <div class="photo">
                                            <img src="{{ url_for('static',filename='images/BLA.jpg') }}" alt="Profile Photo">
                                        </div>
                                    </a>
                                </li>
                                <li class>
                                    <a href="#">Log Out</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
                <div class="modal modal-search fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModal" style="display: none;" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header" data-dashlane-rid="88b86deec8f4a1ad">
                        <input type="text" class="form-control" id="inlineFormInputGroup" placeholder="SEARCH" data-dashlane-rid="22b55a4010048a72">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" data-dashlane-rid="5692c587711cc0f2">
                            <i class="tim-icons icon-simple-remove"></i>
                        </button>
                        </div>
                    </div>
                    </div>
                </div>
                <!-- End Navbar -->
                <div class="content">
                    <h1>Viu More Site Safety Detection - Camera Settings - Add Zone</h1>
                    <div class="content">
                        <div class="card">
                          <div class="card-header">
                            <h4 class="card-title">{{camera}}</h4>
                          </div>
                          <div class="card-body">
                            <form method="get" action="/" class="form-horizontal" data-dashlane-rid="16d0ce49f4a8632f" data-form-type="other">   
                              <div class="row">
                                  <label class="col-sm-2 col-form-label">Detection Classes</label>
                                  <div class="col-sm-10">
                                    <div class="form-check form-check-inline">
                                      <label class="form-check-label">
                                        <input class="form-check-input" type="checkbox" id="Person" name="check_classes">
                                        <span class="form-check-sign"></span>
                                        Person
                                      </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                      <label class="form-check-label">
                                        <input class="form-check-input" type="checkbox" id="Truck" name="check_classes">
                                        <span class="form-check-sign"></span>
                                        Truck
                                      </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                      <label class="form-check-label">
                                        <input class="form-check-input" type="checkbox" id="Car" name="check_classes">
                                        <span class="form-check-sign"></span>
                                        Car
                                      </label>
                                    </div>
                                  </div>
                                </div>
                                <div class="row">
                                    <label class="col-sm-2 col-form-label">Image</label>
                                    <div class="col-sm-10"> 
                                      <div class="info" style="padding-top: 10px;">
                                        <p class="points-info">No points yet</p>
                                      </div>
                                      <div class="output">
                                        <canvas></canvas>
                                      </div>
                                      <a id="confirm" style="padding: 11px 15px; background-image: linear-gradient(to bottom left, #000, #000, #000)" class="btn btn-primary">Confirm points & detection classes</a>
                                      <a id="clear" style="padding: 11px 15px; background-image: linear-gradient(to bottom left, #000, #000, #000)" class="btn btn-primary">Clear points</a>
                                    </div>
                                  </div>
                              </div>
                            </form>
                          </div>
                        </div>
                    </div> 
                </div>
            </div>
        </div>
    </body>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script>
        function closeNav() {
        document.getElementById("my_sidebar").style.width = "0px";
        document.getElementById("main").style.marginLeft= "0px";
        document.getElementById("open_sidebar_button").style.marginLeft= "0px";
        }

        function openNav() {
        document.getElementById("my_sidebar").style.width = "300px";
        document.getElementById("main").style.marginLeft = "300px";
        document.getElementById("wrapper").style.width = "calc(100vh-300px)";
        }

        var canvas = document.querySelector("canvas");
        var context = canvas.getContext("2d");
        var infoPoints = document.querySelector(".points-info");
        var picker = document.querySelector("input")
        var clickPoints = [];

        canvas.addEventListener("click", evt => {
        clickPoints.push([evt.offsetX, evt.offsetY])
        drawDot(evt.offsetX, evt.offsetY)
        infoPoints.textContent = clickPoints.join(" : ")
        })
        
        // draw polygon from a list of 4 points
        const drawPoly = points => {
          context.lineWidth = 2
          context.clearRect(0, 0, canvas.width, canvas.height)
          passDataPoints(clickPoints)
          var split = points.splice(0, clickPoints.length)
          context.beginPath()
          context.moveTo(split[0][0], split[0][1])
          for(i of split.reverse()) context.lineTo(i[0], i[1])
          context.stroke()
        }

        // draw a dot.
        const drawDot = (x, y) => {
          context.beginPath()
          context.arc(x, y, 4, 0, 2*Math.PI);
          context.fill()
        }

        /* // resize the canvas for the image
        var biggest = 500;
        var axis
        const resize = (x, y) => {
          // so that the biggest axis is always {biggest} px
          var ratio = x > y ? x / biggest : y / biggest
          axis = [x / ratio, y / ratio]
          canvas.height = axis[0]
          canvas.width = axis[1]
        } */

        // load a new image
        var rawImg = new Image()
        const newImage = src => {
          rawImg.src = src
          rawImg.onload = () => {
            canvas.style.backgroundImage = "url(" + src + ")"
            canvas.height = rawImg.height
            canvas.width = rawImg.width
            /* resize(rawImg.height, rawImg.width) */
          };
        }

        newImage('{{path | safe}}')

        document.getElementById("confirm").addEventListener("click", confirmZone);

        function confirmZone() {
          drawPoly(clickPoints)
        }

        document.getElementById("clear").addEventListener("click", clearPoints);

        function clearPoints() {
          window.location.href = '/my_cameras/settings/{{camera}}/add_zone'
        }

        function content_checkboxes() {
          let detection_classes = {
            "Person": false,
            "Truck": false,
            "Car": false
          }

          var person_checked = document.getElementById('Person').checked
          if (person_checked) {
            detection_classes["Person"] = true    
          }
          
          var truck_checked = document.getElementById('Truck').checked
          if (truck_checked) {
            detection_classes["Truck"] = true    
          }
          
          var car_checked = document.getElementById('Car').checked
          if (car_checked) {
            detection_classes["Car"] = true    
          }

          return detection_classes
        }

        function passDataPoints(clickPoints) {
          detection_classes = content_checkboxes()
          var zone_cam_data = {'zone': clickPoints, 'camera': '{{camera | safe}}', 'detection_classes': detection_classes}
            $.ajax({
                type: 'POST',
                data: JSON.stringify(zone_cam_data),
                url: '/getzonepoints',
                contentType: "application/json",
                method: 'POST',
                success: function(data_points) {
                    var parsed_data = JSON.parse(data_points)
                    window.location.href = '/my_cameras/settings/{{camera}}'
                }
            });
        }
    </script>
</html>